const API_BASE = "/api";

let listings = [];
let currentLang = localStorage.getItem("lang") || "en";

function t(key) {
  const dict = window.I18N?.[currentLang] || window.I18N?.en || {};
  return dict[key] ?? key;
}

function normalizeType(type) {
  const v = (type || "").toLowerCase();
  if (v === "apartment") return t("apartment");
  if (v === "house") return t("house");
  // если в будущем будут другие типы — покажем как есть
  return type;
}

function applyLangToUI() {
  // RTL для иврита
  document.documentElement.dir = currentLang === "he" ? "rtl" : "ltr";

  // Заголовки/лейблы (ищем элементы по id)
  const elCatalog = document.getElementById("titleCatalog");
  const elLangLabel = document.getElementById("labelLanguage");
  const elCity = document.getElementById("labelCity");
  const elDistrict = document.getElementById("labelDistrict");
  const elType = document.getElementById("labelType");
  const elMaxPrice = document.getElementById("labelMaxPrice");
  const elReset = document.getElementById("btnReset");
  const elShow = document.getElementById("btnShow");
  const elListingsTitle = document.getElementById("titleListings");

  if (elCatalog) elCatalog.textContent = t("catalog");
  if (elLangLabel) elLangLabel.textContent = t("language");
  if (elCity) elCity.textContent = t("city");
  if (elDistrict) elDistrict.textContent = t("district");
  if (elType) elType.textContent = t("type");
  if (elMaxPrice) elMaxPrice.textContent = t("maxPrice");
  if (elReset) elReset.textContent = t("reset");
  if (elShow) elShow.textContent = t("show");
  if (elListingsTitle) elListingsTitle.textContent = t("listings");

  // плейсхолдеры "—"
  setSelectPlaceholder("citySelect");
  setSelectPlaceholder("districtSelect");
  setSelectPlaceholder("typeSelect");

  // перерисовать карточки (чтобы type переводился)
  renderListings(getFilteredListings());
}

function setSelectPlaceholder(selectId) {
  const sel = document.getElementById(selectId);
  if (!sel) return;
  const first = sel.querySelector('option[value=""]');
  if (first) first.textContent = t("any");
}

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`${url} -> ${res.status}`);
  return res.json();
}

function getFilteredListings() {
  const city = document.getElementById("citySelect")?.value || "";
  const district = document.getElementById("districtSelect")?.value || "";
  const type = document.getElementById("typeSelect")?.value || "";
  const maxPrice = Number(document.getElementById("maxPrice")?.value || 0);

  return listings.filter((it) => {
    if (city && it.city !== city) return false;
    if (district && it.district !== district) return false;
    if (type && it.type !== type) return false;
    if (maxPrice && Number(it.price) > maxPrice) return false;
    return true;
  });
}

function renderListings(items) {
  const box = document.getElementById("listingsBox");
  const badge = document.getElementById("listingsCount");
  if (!box) return;

  box.innerHTML = "";
  if (badge) badge.textContent = String(items.length);

  for (const it of items) {
    const card = document.createElement("div");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "cardTitle";
    title.textContent = it.title || "";

    const meta = document.createElement("div");
    meta.className = "cardMeta";
    meta.textContent = `${it.city} • ${it.district} • ${normalizeType(it.type)}`;

    const price = document.createElement("div");
    price.className = "cardPrice";
    price.textContent = `€ ${it.price}`;

    card.appendChild(title);
    card.appendChild(meta);
    card.appendChild(price);

    box.appendChild(card);
  }
}

async function init() {
  // language select
  const langSelect = document.getElementById("langSelect");
  if (langSelect) {
    langSelect.value = currentLang;
    langSelect.addEventListener("change", () => {
      currentLang = langSelect.value;
      localStorage.setItem("lang", currentLang);
      applyLangToUI();
    });
  }

  // load data
  [listings] = await Promise.all([
    fetchJSON(`${API_BASE}/listings`),
  ]);

  // populate filters
  const filters = await fetchJSON(`${API_BASE}/filters`);

  fillSelect("citySelect", filters.cities);
  fillSelect("districtSelect", filters.districts);
  fillSelect("typeSelect", filters.types);

  // buttons
  const btnReset = document.getElementById("btnReset");
  const btnShow = document.getElementById("btnShow");

  if (btnReset) {
    btnReset.addEventListener("click", () => {
      document.getElementById("citySelect").value = "";
      document.getElementById("districtSelect").value = "";
      document.getElementById("typeSelect").value = "";
      document.getElementById("maxPrice").value = "100000";
      renderListings(getFilteredListings());
    });
  }

  if (btnShow) {
    btnShow.addEventListener("click", () => {
      renderListings(getFilteredListings());
    });
  }

  // apply language + initial render
  applyLangToUI();
  renderListings(getFilteredListings());
}

function fillSelect(selectId, values) {
  const sel = document.getElementById(selectId);
  if (!sel) return;

  sel.innerHTML = "";

  // placeholder
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = t("any");
  sel.appendChild(opt0);

  for (const v of values) {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  }
}

document.addEventListener("DOMContentLoaded", init);
